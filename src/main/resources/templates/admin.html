<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeatGuard - 대시보드</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .tab-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        .tab-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 0.625rem 1.25rem;
            font-family: inherit;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            border-color: var(--text-bright);
            color: var(--text-bright);
        }
        .tab-btn.active {
            background: var(--text-bright);
            border-color: var(--text-bright);
            color: var(--bg-deep);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
            max-width: 1200px;
            margin: 0 auto 2rem;
        }
        .stat-card {
            background: linear-gradient(145deg, rgba(40, 53, 64, 0.7), rgba(40, 53, 64, 0.4));
            border: 1px solid rgba(99, 107, 115, 0.25);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        .stat-card h3 {
            font-size: 0.875rem;
            color: var(--text-dim);
            margin-bottom: 0.75rem;
            font-weight: normal;
        }
        .stat-value {
            font-size: 2rem;
            color: var(--text-bright);
            margin-bottom: 0.25rem;
        }
        .stat-unit {
            font-size: 0.875rem;
            color: var(--text-dim);
        }
        
        .ranking-list {
            list-style: none;
        }
        .ranking-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(99, 107, 115, 0.15);
        }
        .ranking-item:last-child {
            border-bottom: none;
        }
        .ranking-rank {
            width: 24px;
            height: 24px;
            background: rgba(99, 107, 115, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-right: 0.75rem;
        }
        .ranking-item:nth-child(1) .ranking-rank {
            background: rgba(212, 104, 90, 0.3);
            color: #D4685A;
        }
        .ranking-item:nth-child(2) .ranking-rank {
            background: rgba(212, 140, 90, 0.3);
            color: #D48C5A;
        }
        .ranking-item:nth-child(3) .ranking-rank {
            background: rgba(212, 180, 90, 0.3);
            color: #D4B45A;
        }
        .ranking-name {
            flex: 1;
            color: var(--text-bright);
        }
        .ranking-value {
            color: var(--text-dim);
            font-size: 0.875rem;
        }
        
        .heatmap-container {
            max-width: 1200px;
            margin: 0 auto;
            overflow-x: auto;
        }
        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        .heatmap-table th {
            padding: 0.5rem 0.25rem;
            color: var(--text-dim);
            font-weight: normal;
            text-align: center;
        }
        .heatmap-table td {
            padding: 0.375rem;
            text-align: center;
        }
        .heatmap-table .name-cell {
            text-align: left;
            color: var(--text-bright);
            padding-right: 1rem;
            white-space: nowrap;
        }
        .heatmap-cell {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            display: inline-block;
        }
        .heat-0 { background: rgba(99, 107, 115, 0.1); }
        .heat-1 { background: rgba(212, 104, 90, 0.3); }
        .heat-2 { background: rgba(212, 104, 90, 0.5); }
        .heat-3 { background: rgba(212, 104, 90, 0.7); }
        .heat-4 { background: rgba(212, 104, 90, 0.9); }
    </style>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#00010D">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="/favicon.png">
</head>
<body>
    <div class="dashboard">
        <header class="dash-header">
            <h1 class="dash-title">관리자</h1>
            <div class="dash-controls">
                <span class="noti-badge" id="notiStatus">알림 연결 중...</span>
                <button id="btnEnableNoti" class="btn btn-sm">알림 받기</button>
                <a href="/logout" class="btn btn-sm">로그아웃</a>
            </div>
        </header>

        <div class="tab-nav">
            <button class="tab-btn active" data-tab="realtime">실시간 현황</button>
            <button class="tab-btn" data-tab="stats">통계</button>
        </div>

        <div id="realtime" class="tab-content active">
            <div class="member-grid" id="userGrid">
                <div class="empty-state">데이터를 불러오는 중...</div>
            </div>
        </div>

        <div id="stats" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>현재 출석률</h3>
                    <div class="stat-value" id="attendanceRate">-</div>
                    <div class="stat-unit">%</div>
                </div>
                <div class="stat-card">
                    <h3>오늘 평균 자리비움</h3>
                    <div class="stat-value" id="avgAway">-</div>
                    <div class="stat-unit">분</div>
                </div>
                <div class="stat-card">
                    <h3>자리비움 TOP 5</h3>
                    <ul class="ranking-list" id="topAwayList"></ul>
                </div>
            </div>
            
            <div class="stat-card" style="max-width: 1200px; margin: 0 auto;">
                <h3 style="margin-bottom: 1rem;">시간대별 자리비움 히트맵</h3>
                <div class="heatmap-container">
                    <table class="heatmap-table" id="heatmapTable">
                        <thead>
                            <tr>
                                <th></th>
                                <th>9</th><th>10</th><th>11</th><th>12</th>
                                <th>13</th><th>14</th><th>15</th><th>16</th>
                                <th>17</th><th>18</th><th>19</th><th>20</th>
                                <th>21</th><th>22</th>
                            </tr>
                        </thead>
                        <tbody id="heatmapBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCz3QIK51dRJxF6KodEqJ7yhh_4lI1reos",
            authDomain: "seatguard-e1ffe.firebaseapp.com",
            projectId: "seatguard-e1ffe",
            storageBucket: "seatguard-e1ffe.firebasestorage.app",
            messagingSenderId: "182765965666",
            appId: "1:182765965666:web:03d7210d1c5f5e1f5bdc3b",
            measurementId: "G-3LFL80GCQC"
        };

        const vapidKey = "BM84-oG76wxyN0Yo9m06gmXe8L_ODDUyxWlq9uXy8zO0hwfxpYyUPw0IxIlZaaqYMM7RK_K5wtdgn4uP7lxy5EM"; 

        try {
            const app = initializeApp(firebaseConfig);
            const messaging = getMessaging(app);
            
            const btn = document.getElementById('btnEnableNoti');
            const status = document.getElementById('notiStatus');

            if (Notification.permission === 'granted') {
                btn.style.display = 'none';
                status.innerText = "알림 연결됨";
                connectToFcm(); 
            } else if (Notification.permission === 'denied') {
                status.innerText = "알림이 차단되어 있습니다";
            }

            btn.addEventListener('click', () => {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        btn.style.display = 'none';
                        status.innerText = "알림 연결됨";
                        connectToFcm();
                    } else {
                        status.innerText = "알림 권한이 거부됨";
                    }
                });
            });

            function connectToFcm() {
                getToken(messaging, { vapidKey: vapidKey }).then((currentToken) => {
                    if (currentToken) {
                        fetch('/api/fcm/token', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: currentToken })
                        });
                    }
                }).catch((err) => {
                    console.error('Token Error:', err);
                    status.innerText = "알림 연결 실패";
                });
            }

            onMessage(messaging, (payload) => {
                new Notification(payload.notification.title, {
                    body: payload.notification.body,
                    icon: '/favicon.png'
                });
            });

        } catch(e) {
            console.error("Firebase Init Error:", e);
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
                
                if (btn.dataset.tab === 'stats') {
                    loadStats();
                }
            });
        });

        function formatTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hour = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return `${month}/${day} ${hour}:${min}`;
        }

        function getStatusLabel(status) {
            switch(status) {
                case 'IN': return '자리에 있음';
                case 'AWAY': return '자리 비움';
                case 'DANGER': return '장기 이석 중';
                default: return status;
            }
        }

        function loadDashboard() {
            fetch('/api/admin/dashboard')
                .then(res => {
                    if (res.status === 403) window.location.href = '/';
                    return res.json();
                })
                .then(data => {
                    const grid = document.getElementById('userGrid');
                    grid.innerHTML = '';
                    
                    if (data.length === 0) {
                        grid.innerHTML = '<div class="empty-state">현재 접속 중인 인원이 없습니다</div>';
                        return;
                    }
                    
                    data.forEach(u => {
                        const card = document.createElement('div');
                        card.className = `member-card card-${u.status}`;
                        card.innerHTML = `
                            <div class="member-header">
                                <span class="member-dot"></span>
                                <span class="member-name">${u.name}</span>
                            </div>
                            <p class="member-status">${getStatusLabel(u.status)}</p>
                            <p class="member-time">${formatTime(u.lastChange)}</p>
                        `;
                        grid.appendChild(card);
                    });
                });
        }

        function loadStats() {
            fetch('/api/admin/stats')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('attendanceRate').textContent = data.attendanceRate;
                    document.getElementById('avgAway').textContent = data.avgAwayMinutes;
                    
                    const list = document.getElementById('topAwayList');
                    list.innerHTML = '';
                    if (data.topAwayUsers.length === 0) {
                        list.innerHTML = '<li style="color: var(--text-dim); padding: 0.5rem 0;">데이터 없음</li>';
                    } else {
                        data.topAwayUsers.forEach((u, i) => {
                            const li = document.createElement('li');
                            li.className = 'ranking-item';
                            li.innerHTML = `
                                <span class="ranking-rank">${i + 1}</span>
                                <span class="ranking-name">${u.name}</span>
                                <span class="ranking-value">${u.awayMinutes}분</span>
                            `;
                            list.appendChild(li);
                        });
                    }
                    
                    const tbody = document.getElementById('heatmapBody');
                    tbody.innerHTML = '';
                    const hours = [9,10,11,12,13,14,15,16,17,18,19,20,21,22];
                    
                    data.heatmapData.forEach(user => {
                        const tr = document.createElement('tr');
                        let cells = `<td class="name-cell">${user.name}</td>`;
                        hours.forEach(h => {
                            const val = user.hours[h] || 0;
                            const level = Math.min(val, 4);
                            cells += `<td><span class="heatmap-cell heat-${level}"></span></td>`;
                        });
                        tr.innerHTML = cells;
                        tbody.appendChild(tr);
                    });
                });
        }
        
        setInterval(loadDashboard, 3000);
        loadDashboard();
    </script>
</body>
</html>
